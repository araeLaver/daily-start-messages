<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모닝 - 아침 메시지</title>
    <meta name="description" content="새로운 아침을 시작하는 따뜻하고 힘이 되는 메시지를 만나보세요">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="모닝">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/loader.css">
    <link rel="stylesheet" href="css/accessibility.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- 접근성: Skip to content 링크 -->
    <a href="#main-content" class="skip-link">메인 콘텐츠로 건너뛰기</a>
    
    <!-- 햄버거 메뉴 버튼 -->
    <button class="hamburger-btn" id="hamburgerBtn" aria-label="메뉴 열기">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- 사이드바 메뉴 -->
    <nav class="sidebar" id="sidebar" aria-label="메인 네비게이션">
        <div class="sidebar-header">
            <h2>🌅 모닝</h2>
            <button class="sidebar-close" id="sidebarClose" aria-label="메뉴 닫기">&times;</button>
        </div>
        
        <div class="sidebar-content">
            <div class="user-info" id="userInfo">
                <div class="user-greeting">안녕하세요!</div>
                <div class="user-streak">
                    <span class="streak-icon">🔥</span>
                    <span id="streakNumber">0</span>일 연속 방문
                </div>
                <div class="user-actions">
                    <button class="auth-btn" id="loginBtn" onclick="showAuthModal('login')">로그인</button>
                    <button class="auth-btn" id="logoutBtn" onclick="logout()" style="display: none;">로그아웃</button>
                </div>
            </div>

            <div class="menu-section">
                <h3>📝 메시지</h3>
                <button class="menu-item" id="newQuoteBtn" data-action="newQuote">
                    <span class="menu-icon">🌅</span>
                    새로운 메시지
                </button>
                <button class="menu-item" id="favoritesBtn" data-action="favorites">
                    <span class="menu-icon">⭐</span>
                    즐겨찾기
                </button>
                <button class="menu-item" id="historyBtn" data-action="history">
                    <span class="menu-icon">📚</span>
                    히스토리
                </button>
                <button class="menu-item" id="popularBtn" data-action="popular">
                    <span class="menu-icon">🔥</span>
                    인기 메시지
                </button>
            </div>

            <div class="menu-section">
                <h3>📱 기능</h3>
                <button class="menu-item" id="shareBtn" data-action="share">
                    <span class="menu-icon">💌</span>
                    공유하기
                </button>
                <button class="menu-item" id="speakBtn" data-action="speak">
                    <span class="menu-icon">🔊</span>
                    음성듣기
                </button>
            </div>

            <div class="menu-section">
                <h3>🌍 커뮤니티</h3>
                <button class="menu-item" id="submitBtn" data-action="submit">
                    <span class="menu-icon">✍️</span>
                    메시지 제출
                </button>
                <button class="menu-item" id="inviteBtn" data-action="invite">
                    <span class="menu-icon">👥</span>
                    친구 초대
                </button>
            </div>

            <div class="menu-section">
                <h3>⚙️ 설정</h3>
                <button class="menu-item" id="settingsBtn" data-action="settings">
                    <span class="menu-icon">⚙️</span>
                    앱 설정
                </button>
            </div>
        </div>
    </nav>

    <!-- 사이드바 오버레이 -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-container">
        <!-- 깔끔한 헤더 -->
        <header class="header">
            <div class="time-greeting" id="timeGreeting"></div>
            <div class="header-indicators">
                <div class="seasonal-indicator" id="seasonalIndicator" title="현재 계절"></div>
                <div class="event-indicator" id="eventIndicator" title="활성 이벤트" style="display: none;"></div>
            </div>
        </header>
        
        <!-- 메인 콘텐츠: 글귀만 표시 -->
        <main class="main-content" id="main-content">
            <div class="quote-container">
                <div class="quote-card" id="quoteCard">
                    <div class="loading" id="loading">
                        <div class="loading-spinner"></div>
                        <p>새로운 메시지를 준비하고 있어요...</p>
                    </div>
                    <div class="quote-content" id="quoteContent" style="display: none;">
                        <div class="quote-actions">
                            <button class="favorite-btn" id="favoriteBtn" aria-label="즐겨찾기 추가/제거">
                                <span class="favorite-icon">🤍</span>
                            </button>
                        </div>
                        <blockquote class="quote-text" id="quoteText"></blockquote>
                        <div class="quote-category" id="quoteCategory"></div>
                        <div class="quote-reactions">
                            <button class="reaction-btn" id="likeBtn" data-reaction="like" aria-label="좋아요" onclick="handleReaction('like')">
                                <span class="reaction-icon">👍</span>
                                <span class="reaction-count" id="likeCount">0</span>
                            </button>
                            <button class="reaction-btn" id="heartBtn" data-reaction="heart" aria-label="공감" onclick="handleReaction('heart')">
                                <span class="reaction-icon">❤️</span>
                                <span class="reaction-count" id="heartCount">0</span>
                            </button>
                            <button class="reaction-btn" id="fireBtn" data-reaction="fire" aria-label="핫" onclick="handleReaction('fire')">
                                <span class="reaction-icon">🔥</span>
                                <span class="reaction-count" id="fireCount">0</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 간단한 액션 버튼들 -->
                <div class="quick-actions">
                    <button class="quick-action-btn" id="quickNewBtn" aria-label="새로운 메시지" title="새로운 메시지">
                        🔄
                    </button>
                    <button class="quick-action-btn" id="quickShareBtn" aria-label="공유하기" title="공유하기">
                        📤
                    </button>
                    <button class="quick-action-btn" id="quickSpeakBtn" aria-label="음성듣기" title="음성듣기">
                        🔊
                    </button>
                </div>
            </div>
        </main>
        
        <!-- 미니멀 푸터 -->
        <footer class="footer">
            <div class="date-display" id="dateDisplay"></div>
            <div class="message-counter">
                <span id="messageCounter">1</span>번째 메시지
            </div>
        </footer>
    </div>

    <!-- 카테고리 필터 모달 -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🏷️ 카테고리 선택</h2>
                <button class="modal-close" id="categoryModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="category-grid">
                    <button class="category-btn active" data-category="all">
                        <span class="category-icon">🌟</span>
                        <span class="category-name">모든 카테고리</span>
                    </button>
                    <button class="category-btn" data-category="새로운 시작">
                        <span class="category-icon">🌅</span>
                        <span class="category-name">새로운 시작</span>
                    </button>
                    <button class="category-btn" data-category="동기부여">
                        <span class="category-icon">💪</span>
                        <span class="category-name">동기부여</span>
                    </button>
                    <button class="category-btn" data-category="감사">
                        <span class="category-icon">🙏</span>
                        <span class="category-name">감사</span>
                    </button>
                    <button class="category-btn" data-category="위로">
                        <span class="category-icon">🤗</span>
                        <span class="category-name">위로</span>
                    </button>
                    <button class="category-btn" data-category="성찰">
                        <span class="category-icon">💭</span>
                        <span class="category-name">성찰</span>
                    </button>
                    <button class="category-btn" data-category="희망">
                        <span class="category-icon">✨</span>
                        <span class="category-name">희망</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>메시지 공유하기</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="share-preview" id="sharePreview"></div>
                <div class="share-buttons">
                    <button class="share-btn" id="copyBtn">📋 텍스트 복사</button>
                    <button class="share-btn" id="kakaoBtn">💬 카카오톡</button>
                    <button class="share-btn" id="twitterBtn">🐦 트위터</button>
                    <button class="share-btn" id="facebookBtn">📘 페이스북</button>
                    <button class="share-btn" id="webShareBtn" style="display: none;">📱 네이티브 공유</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 설정 모달 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ 설정</h2>
                <button class="modal-close" id="settingsModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="simple-settings">
                    <div class="setting-section">
                        <h3 class="setting-section-title">👤 개인화</h3>
                        <div class="setting-row">
                            <span>📝 이름</span>
                            <input type="text" id="userNameInput" class="text-input" placeholder="이름을 입력하세요" maxlength="10">
                        </div>
                        <div class="setting-row">
                            <span>🎨 테마</span>
                            <select id="themeSelect" class="theme-select">
                                <option value="default">기본</option>
                                <option value="spring">🌸 봄</option>
                                <option value="summer">☀️ 여름</option>
                                <option value="autumn">🍂 가을</option>
                                <option value="winter">❄️ 겨울</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <span>📱 표시 방식</span>
                            <select id="displayModeSelect" class="display-mode-select">
                                <option value="card">카드형</option>
                                <option value="minimal">미니멀</option>
                                <option value="typewriter">타이핑</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-section">
                        <h3 class="setting-section-title">⚙️ 기본 설정</h3>
                        <div class="setting-row">
                            <span>🌙 다크모드</span>
                            <input type="checkbox" id="darkModeToggle" class="simple-toggle" aria-label="다크모드 활성화">
                        </div>
                        <div class="setting-row">
                            <span>🔔 알림</span>
                            <input type="checkbox" id="notificationToggle" class="simple-toggle" aria-label="알림 활성화">
                        </div>
                        <div class="setting-row" id="notificationTimeRow" style="display: none;">
                            <span>⏰ 알림 시간</span>
                            <input type="time" id="notificationTime" value="08:00" class="time-input">
                        </div>
                        <div class="setting-row">
                            <span>🌸 계절별 메시지</span>
                            <input type="checkbox" id="seasonalToggle" class="simple-toggle" aria-label="계절별 메시지 활성화">
                        </div>
                        <div class="setting-row">
                            <span>🎊 특별한 날 메시지</span>
                            <input type="checkbox" id="specialDayToggle" class="simple-toggle" aria-label="특별한 날 메시지 활성화">
                        </div>
                        <div class="setting-row">
                            <span>📅 이벤트 메시지</span>
                            <input type="checkbox" id="eventToggle" class="simple-toggle" aria-label="이벤트 메시지 활성화">
                        </div>
                    </div>
                    
                    <div class="app-info">
                        <p>매일 새로운 메시지로 좋은 하루를 시작하세요</p>
                        <small>버전 4.0 - 사용자 제출 시스템</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 즐겨찾기 모달 -->
    <div class="modal" id="favoritesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⭐ 즐겨찾기</h2>
                <button class="modal-close" id="favoritesModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="favorites-container">
                    <div class="favorites-empty" id="favoritesEmpty" style="display: none;">
                        <p>아직 즐겨찾기한 메시지가 없습니다.</p>
                        <small>마음에 드는 메시지에서 🤍 버튼을 눌러보세요!</small>
                    </div>
                    <div class="favorites-list" id="favoritesList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 히스토리 모달 -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📚 메시지 히스토리</h2>
                <button class="modal-close" id="historyModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="history-container">
                    <div class="history-controls">
                        <div class="history-stats">
                            <span id="historyCount">0</span>개의 메시지를 확인했습니다
                        </div>
                        <button class="clear-history-btn" id="clearHistoryBtn">기록 삭제</button>
                    </div>
                    <div class="history-empty" id="historyEmpty" style="display: none;">
                        <p>아직 확인한 메시지가 없습니다.</p>
                        <small>메시지를 보면 여기에 기록됩니다!</small>
                    </div>
                    <div class="history-list" id="historyList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 인기 메시지 모달 -->
    <div class="modal" id="popularModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔥 오늘의 인기 메시지</h2>
                <button class="modal-close" id="popularModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="popular-container">
                    <div class="popular-info">
                        <p>가장 많은 반응을 받은 메시지들입니다</p>
                    </div>
                    <div class="popular-empty" id="popularEmpty" style="display: none;">
                        <p>아직 인기 메시지가 없습니다.</p>
                        <small>메시지에 반응을 남겨보세요! 👍❤️🔥</small>
                    </div>
                    <div class="popular-list" id="popularList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 친구 초대 모달 -->
    <div class="modal" id="inviteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>👥 친구 초대하기</h2>
                <button class="modal-close" id="inviteModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="invite-container">
                    <div class="invite-message">
                        <h3>좋은 메시지를 친구들과 함께 나눠보세요!</h3>
                        <p>매일 아침 따뜻한 메시지로 하루를 시작하는 모닝 앱을 추천해보세요.</p>
                    </div>
                    <div class="invite-preview">
                        <div class="invite-text" id="inviteText">
                            "매일 아침 따뜻한 메시지로 하루를 시작해보세요! 🌅
                            
모닝 앱에서 다양한 명언과 좋은 글귀를 만나보실 수 있습니다.

📱 지금 바로 체험: {{APP_URL}}"
                        </div>
                    </div>
                    <div class="invite-buttons">
                        <button class="btn btn-primary" id="copyInviteBtn">📋 초대 메시지 복사</button>
                        <button class="btn btn-secondary" id="shareInviteBtn">📱 앱으로 공유</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- 습관 트래커 모달 -->
    <div class="modal" id="habitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📈 습관 트래커</h2>
                <button class="modal-close" id="habitModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="habit-container">
                    <div class="habit-stats">
                        <div class="stat-card">
                            <div class="stat-icon">🔥</div>
                            <div class="stat-info">
                                <div class="stat-number" id="currentStreak">0</div>
                                <div class="stat-label">연속 방문</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📅</div>
                            <div class="stat-info">
                                <div class="stat-number" id="totalDays">0</div>
                                <div class="stat-label">총 방문일</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📝</div>
                            <div class="stat-info">
                                <div class="stat-number" id="journalCount">0</div>
                                <div class="stat-label">작성한 일기</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="habit-calendar">
                        <h3>이번 달 활동</h3>
                        <div class="calendar-grid" id="calendarGrid"></div>
                        <div class="calendar-legend">
                            <div class="legend-item">
                                <div class="legend-color active"></div>
                                <span>활동한 날</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color inactive"></div>
                                <span>활동하지 않은 날</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- 사용자 제출 모달 -->
    <div class="modal" id="submitModal">
        <div class="modal-content submit-modal-content">
            <div class="modal-header">
                <h2>✍️ 메시지 제출하기</h2>
                <button class="modal-close" id="submitModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="submit-container">
                    <div class="submit-tabs">
                        <button class="submit-tab active" data-tab="create">새 메시지</button>
                        <button class="submit-tab" data-tab="my-messages">내 메시지</button>
                        <button class="submit-tab" data-tab="community">커뮤니티</button>
                    </div>
                    
                    <!-- 새 메시지 작성 탭 -->
                    <div class="submit-tab-content active" id="createTab">
                        <div class="submit-inspiration">
                            <div class="inspiration-text">
                                "당신의 따뜻한 메시지가 다른 사람의 하루를 밝힐 수 있습니다" 💫
                            </div>
                        </div>
                        
                        <div class="message-form">
                            <div class="form-group">
                                <label for="messageText">메시지 내용</label>
                                <textarea 
                                    id="messageText" 
                                    class="message-textarea" 
                                    placeholder="다른 사람에게 힘이 되는 따뜻한 메시지를 작성해주세요...&#10;&#10;예시:&#10;- 오늘도 최선을 다하는 당신이 자랑스럽습니다&#10;- 작은 걸음도 앞으로 나아가는 것입니다&#10;- 당신의 존재만으로도 세상이 더 밝아집니다"
                                    rows="6"
                                    maxlength="200"></textarea>
                                <div class="char-counter">
                                    <span id="messageCharCount">0</span> / 200
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group half">
                                    <label for="messageAuthor">작성자</label>
                                    <input type="text" id="messageAuthor" placeholder="익명" maxlength="20">
                                </div>
                                <div class="form-group half">
                                    <label for="messageCategory">카테고리</label>
                                    <select id="messageCategory">
                                        <option value="동기부여">💪 동기부여</option>
                                        <option value="위로">🤗 위로</option>
                                        <option value="감사">🙏 감사</option>
                                        <option value="희망">✨ 희망</option>
                                        <option value="성장">🌱 성장</option>
                                        <option value="긍정">😊 긍정</option>
                                        <option value="사랑">❤️ 사랑</option>
                                        <option value="용기">💪 용기</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group half">
                                    <label for="messageTimeOfDay">시간대</label>
                                    <select id="messageTimeOfDay">
                                        <option value="">언제나</option>
                                        <option value="morning">🌅 아침</option>
                                        <option value="afternoon">☀️ 오후</option>
                                        <option value="evening">🌆 저녁</option>
                                        <option value="night">🌙 밤</option>
                                    </select>
                                </div>
                                <div class="form-group half">
                                    <label for="messageSeason">계절</label>
                                    <select id="messageSeason">
                                        <option value="all">모든 계절</option>
                                        <option value="spring">🌸 봄</option>
                                        <option value="summer">☀️ 여름</option>
                                        <option value="autumn">🍂 가을</option>
                                        <option value="winter">❄️ 겨울</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="submit-actions">
                                <button class="btn btn-secondary" id="previewMessageBtn">미리보기</button>
                                <button class="btn btn-primary" id="submitMessageBtn">제출하기</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 내 메시지 탭 -->
                    <div class="submit-tab-content" id="myMessagesTab">
                        <div class="my-messages-header">
                            <h3>📝 내가 작성한 메시지</h3>
                            <div class="my-messages-stats">
                                <span id="myMessagesCount">0</span>개의 메시지를 작성했습니다
                            </div>
                        </div>
                        
                        <div class="my-messages-empty" id="myMessagesEmpty" style="display: none;">
                            <p>아직 작성한 메시지가 없습니다</p>
                            <small>새 메시지 탭에서 첫 번째 메시지를 작성해보세요! ✍️</small>
                        </div>
                        
                        <div class="my-messages-list" id="myMessagesList"></div>
                    </div>
                    
                    <!-- 커뮤니티 탭 -->
                    <div class="submit-tab-content" id="communityTab">
                        <div class="community-header">
                            <h3>🌍 커뮤니티 메시지</h3>
                            <div class="community-stats">
                                <span id="communityCount">0</span>개의 커뮤니티 메시지
                            </div>
                        </div>
                        
                        <div class="community-filters">
                            <select id="communityFilter">
                                <option value="all">전체 보기</option>
                                <option value="recent">최신순</option>
                                <option value="popular">인기순</option>
                                <option value="my-category">내 관심 카테고리</option>
                            </select>
                        </div>
                        
                        <div class="community-empty" id="communityEmpty" style="display: none;">
                            <p>커뮤니티 메시지가 없습니다</p>
                            <small>첫 번째 메시지를 작성해서 커뮤니티를 시작해보세요! 🌟</small>
                        </div>
                        
                        <div class="community-list" id="communityList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 인증 모달 (로그인/회원가입) -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="authModalTitle">로그인</h2>
                <button class="modal-close" data-modal="authModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">로그인</button>
                    <button class="auth-tab" onclick="switchAuthTab('register')">회원가입</button>
                </div>
                
                <!-- 로그인 폼 -->
                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginUsername">사용자명</label>
                        <input type="text" id="loginUsername" required minlength="3" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">비밀번호</label>
                        <input type="password" id="loginPassword" required minlength="6">
                    </div>
                    <button type="submit" class="btn-primary">로그인</button>
                </form>
                
                <!-- 회원가입 폼 -->
                <form id="registerForm" class="auth-form" style="display: none;">
                    <div class="form-group">
                        <label for="registerUsername">사용자명</label>
                        <input type="text" id="registerUsername" required minlength="3" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">이메일 (선택사항)</label>
                        <input type="email" id="registerEmail">
                    </div>
                    <div class="form-group">
                        <label for="registerDisplayName">표시 이름</label>
                        <input type="text" id="registerDisplayName" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">비밀번호</label>
                        <input type="password" id="registerPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="registerPasswordConfirm">비밀번호 확인</label>
                        <input type="password" id="registerPasswordConfirm" required minlength="6">
                    </div>
                    <button type="submit" class="btn-primary">회원가입</button>
                </form>
                
                <div id="authMessage" class="auth-message"></div>
            </div>
        </div>
    </div>

    <!-- 메시지 미리보기 모달 -->
    <div class="modal" id="previewModal">
        <div class="modal-content preview-modal-content">
            <div class="modal-header">
                <h2>👀 메시지 미리보기</h2>
                <button class="modal-close" id="previewModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="preview-container">
                    <div class="preview-quote-card">
                        <blockquote class="preview-quote-text" id="previewText"></blockquote>
                        <cite class="preview-quote-author" id="previewAuthor"></cite>
                        <div class="preview-quote-category" id="previewCategory"></div>
                        <div class="preview-quote-meta">
                            <span id="previewTimeOfDay"></span>
                            <span id="previewSeason"></span>
                        </div>
                    </div>
                    
                    <div class="preview-actions">
                        <button class="btn btn-secondary" id="editMessageBtn">수정하기</button>
                        <button class="btn btn-primary" id="confirmSubmitBtn">제출 확정</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

 
    
    <!-- 카카오 SDK -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js" 
            integrity="sha384-TiCUE00h649CAMonG018J2ujOgDKW/kVWlChEuu4jK2vxfAAD0eZxzCKakxg55G4" 
            crossorigin="anonymous"></script>
    
    <!-- 원본 script.js 대신 안전한 인라인 스크립트 -->
    <script>
        console.log('안전한 스크립트 시작...');

        // API 설정
        const API_BASE_URL = 'http://localhost:8002';
        let currentUser = null;
        let authToken = null;

        // 로컬 스토리지에서 토큰 확인
        function loadUserSession() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');
            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                updateUserInterface();
            }
        }

        // 사용자 인터페이스 업데이트
        function updateUserInterface() {
            const userInfo = safeGetElement('userInfo');
            if (userInfo && currentUser) {
                const greeting = userInfo.querySelector('.user-greeting');
                if (greeting) {
                    greeting.textContent = `안녕하세요, ${currentUser.display_name || currentUser.username}님!`;
                }
            }
        }

        // API 호출 헬퍼 함수
        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            const response = await fetch(url, {
                ...options,
                headers
            });
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            
            return response.json();
        }

        // 회원가입
        async function register(username, email, password, displayName) {
            try {
                const response = await apiCall('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        display_name: displayName
                    })
                });
                
                authToken = response.access_token;
                currentUser = response.user;
                
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                updateUserInterface();
                return response;
            } catch (error) {
                console.error('회원가입 오류:', error);
                throw error;
            }
        }

        // 로그인
        async function login(username, password) {
            try {
                const response = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        username,
                        password
                    })
                });
                
                authToken = response.access_token;
                currentUser = response.user;
                
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                updateUserInterface();
                return response;
            } catch (error) {
                console.error('로그인 오류:', error);
                throw error;
            }
        }

        // 로그아웃
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            updateUserInterface();
        }

        // 로컬 즐겨찾기 관리
        let localFavorites = [];

        // 로컬 스토리지에서 즐겨찾기 로드
        function loadLocalFavorites() {
            try {
                const saved = localStorage.getItem('favorites');
                localFavorites = saved ? JSON.parse(saved) : [];
                console.log(`${localFavorites.length}개의 즐겨찾기를 로드했습니다.`);
            } catch (error) {
                console.error('즐겨찾기 로드 실패:', error);
                localFavorites = [];
            }
        }

        // 즐겨찾기 저장
        function saveLocalFavorites() {
            try {
                localStorage.setItem('favorites', JSON.stringify(localFavorites));
            } catch (error) {
                console.error('즐겨찾기 저장 실패:', error);
            }
        }

        // 즐겨찾기 추가
        function addFavorite(messageId, messageData) {
            try {
                // 중복 확인
                const existingIndex = localFavorites.findIndex(fav => fav.message_id === messageId);
                if (existingIndex >= 0) {
                    console.log('이미 즐겨찾기에 있는 메시지입니다.');
                    return false;
                }

                // 새 즐겨찾기 추가
                const newFavorite = {
                    id: Date.now().toString(),
                    message_id: messageId,
                    message_data: messageData,
                    added_at: new Date().toISOString()
                };

                localFavorites.unshift(newFavorite);
                saveLocalFavorites();
                console.log('즐겨찾기에 추가되었습니다.');
                return true;
            } catch (error) {
                console.error('즐겨찾기 추가 오류:', error);
                return false;
            }
        }

        // 즐겨찾기 제거
        function removeFavorite(messageId) {
            try {
                const originalLength = localFavorites.length;
                localFavorites = localFavorites.filter(fav => fav.message_id !== messageId);
                
                if (localFavorites.length < originalLength) {
                    saveLocalFavorites();
                    console.log('즐겨찾기에서 제거되었습니다.');
                    return true;
                }
                return false;
            } catch (error) {
                console.error('즐겨찾기 제거 오류:', error);
                return false;
            }
        }

        // 즐겨찾기 목록 조회
        function getFavorites() {
            return localFavorites;
        }

        // 즐겨찾기 여부 확인
        function isFavorite(messageId) {
            return localFavorites.some(fav => fav.message_id === messageId);
        }

        // 인증 모달 표시
        function showAuthModal(type = 'login') {
            const modal = safeGetElement('authModal');
            if (modal) {
                modal.style.display = 'block';
                switchAuthTab(type);
            }
        }

        // 인증 탭 전환
        function switchAuthTab(type) {
            const loginForm = safeGetElement('loginForm');
            const registerForm = safeGetElement('registerForm');
            const authModalTitle = safeGetElement('authModalTitle');
            const tabs = document.querySelectorAll('.auth-tab');
            
            // 탭 버튼 스타일 업데이트
            tabs.forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.auth-tab[onclick*="${type}"]`).classList.add('active');
            
            if (type === 'login') {
                if (loginForm) loginForm.style.display = 'block';
                if (registerForm) registerForm.style.display = 'none';
                if (authModalTitle) authModalTitle.textContent = '로그인';
            } else {
                if (loginForm) loginForm.style.display = 'none';
                if (registerForm) registerForm.style.display = 'block';
                if (authModalTitle) authModalTitle.textContent = '회원가입';
            }
            
            // 메시지 초기화
            const authMessage = safeGetElement('authMessage');
            if (authMessage) authMessage.textContent = '';
        }

        // 인증 메시지 표시
        function showAuthMessage(message, isError = false) {
            const authMessage = safeGetElement('authMessage');
            if (authMessage) {
                authMessage.textContent = message;
                authMessage.style.color = isError ? '#e74c3c' : '#27ae60';
            }
        }

        // 사용자 인터페이스 업데이트 (로그인 상태 반영)
        function updateUserInterface() {
            const userInfo = safeGetElement('userInfo');
            const loginBtn = safeGetElement('loginBtn');
            const logoutBtn = safeGetElement('logoutBtn');
            
            if (currentUser) {
                // 로그인 상태
                if (userInfo) {
                    const greeting = userInfo.querySelector('.user-greeting');
                    if (greeting) {
                        greeting.textContent = `안녕하세요, ${currentUser.display_name || currentUser.username}님!`;
                    }
                }
                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'block';
            } else {
                // 로그아웃 상태
                if (userInfo) {
                    const greeting = userInfo.querySelector('.user-greeting');
                    if (greeting) {
                        greeting.textContent = '안녕하세요!';
                    }
                }
                if (loginBtn) loginBtn.style.display = 'block';
                if (logoutBtn) logoutBtn.style.display = 'none';
            }
        }


        // 히스토리 모달 표시  
        function showHistoryModal() {
            const modal = safeGetElement('historyModal');
            const historyContent = modal?.querySelector('.modal-body');
            
            if (!modal || !historyContent) {
                alert('히스토리 모달을 찾을 수 없습니다.');
                return;
            }
            
            if (messageHistory.length === 0) {
                historyContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <p>아직 본 메시지가 없습니다.</p>
                        <p>메시지를 확인하면 여기에 기록됩니다.</p>
                    </div>
                `;
            } else {
                const historyHtml = messageHistory.map((msg, index) => `
                    <div class="history-item" style="margin-bottom: 1rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;" 
                         onclick="showHistoryMessage(${index})">
                        <div style="font-size: 0.9rem; color: #374151; margin-bottom: 0.5rem;">
                            ${msg.text.length > 80 ? msg.text.substring(0, 80) + '...' : msg.text}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.8rem; color: #6b7280;">#${msg.category}</span>
                            <span style="font-size: 0.75rem; color: #9ca3af;">
                                ${new Date(msg.viewedAt).toLocaleDateString('ko-KR')}
                            </span>
                        </div>
                    </div>
                `).join('');
                
                historyContent.innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${historyHtml}
                    </div>
                `;
            }
            
            modal.style.display = 'block';
        }

        // 히스토리에서 메시지 선택
        function showHistoryMessage(index) {
            const message = messageHistory[index];
            if (message) {
                // 현재 메시지 배열에서 해당 메시지 찾기
                const messageIndex = messages.findIndex(msg => msg.id === message.id);
                if (messageIndex >= 0) {
                    showMessage(messageIndex, false);
                }
                const modal = safeGetElement('historyModal');
                if (modal) modal.style.display = 'none';
            }
        }


        // 즐겨찾기 모달 표시
        function showFavoritesModal() {
            const modal = safeGetElement('favoritesModal');
            const favoritesContent = modal?.querySelector('.modal-body');
            
            if (!modal || !favoritesContent) {
                alert('즐겨찾기 모달을 찾을 수 없습니다.');
                return;
            }
            
            const favorites = getFavorites();
            
            if (favorites.length === 0) {
                favoritesContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <p>아직 즐겨찾기에 추가된 메시지가 없습니다.</p>
                        <p>마음에 드는 메시지를 ❤️ 버튼으로 추가해보세요!</p>
                    </div>
                `;
            } else {
                const favoritesHtml = favorites.map((fav, index) => `
                    <div class="favorite-item" style="margin-bottom: 1rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; position: relative;">
                        <button onclick="removeFavoriteFromModal('${fav.message_id}', ${index})" 
                                style="position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #ef4444;" 
                                title="즐겨찾기에서 제거">
                            ×
                        </button>
                        <blockquote style="margin: 0 0 0.5rem 0; font-style: italic; color: #374151;">
                            "${fav.message_data.text}"
                        </blockquote>
                        <div style="margin-top: 0.5rem;">
                            <span style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; color: #6b7280;">
                                #${fav.message_data.category}
                            </span>
                            <span style="margin-left: 0.5rem; font-size: 0.8rem; color: #9ca3af;">
                                ${new Date(fav.added_at).toLocaleDateString('ko-KR')}
                            </span>
                        </div>
                    </div>
                `).join('');
                
                favoritesContent.innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto;">
                        <div style="margin-bottom: 1rem; text-align: center; color: #6b7280; font-size: 0.9rem;">
                            총 ${favorites.length}개의 즐겨찾기
                        </div>
                        ${favoritesHtml}
                    </div>
                `;
            }
            
            modal.style.display = 'block';
        }

        // 즐겨찾기 모달에서 제거
        function removeFavoriteFromModal(messageId, index) {
            const success = removeFavorite(messageId);
            if (success) {
                showFavoritesModal(); // 모달 새로고침
                
                // 현재 표시된 메시지가 제거된 메시지인 경우 하트 아이콘 업데이트
                const currentMessage = messages[currentMessageIndex];
                if (currentMessage && `msg_${currentMessage.id || currentMessageIndex}` === messageId) {
                    const favoriteIcon = document.querySelector('.favorite-icon');
                    if (favoriteIcon) {
                        favoriteIcon.textContent = '🤍';
                    }
                }
            }
        }

        // 메시지 데이터
        let messages = [];
        let allMessages = []; // 전체 메시지 저장용
        
        // 기본 메시지 (JSON 로드 실패시 백업용) - 확장된 메시지 모음
        const fallbackMessages = [
            // 동기부여
            { id: 1, text: "새로운 하루가 시작됩니다. 오늘도 좋은 하루 되세요! 🌅", category: "새로운 시작", timeOfDay: "morning", season: "all" },
            { id: 2, text: "작은 걸음도 앞으로 나아가는 것입니다.", category: "동기부여", timeOfDay: "morning", season: "all" },
            { id: 3, text: "오늘 하루도 감사한 마음으로 시작해보세요.", category: "감사", timeOfDay: "morning", season: "all" },
            { id: 4, text: "당신의 꿈은 충분히 가치가 있습니다.", category: "꿈", timeOfDay: "all", season: "all" },
            { id: 5, text: "지금 이 순간이 새로운 시작의 기회입니다.", category: "기회", timeOfDay: "all", season: "all" },
            
            // 명언
            { id: 6, text: "행복은 습관이다. 그것을 몸에 지니라.", category: "행복", timeOfDay: "all", season: "all" },
            { id: 7, text: "성공은 준비와 기회가 만나는 지점이다.", category: "성공", timeOfDay: "all", season: "all" },
            { id: 8, text: "가장 어두운 밤이 지나면 가장 아름다운 새벽이 온다.", category: "희망", timeOfDay: "morning", season: "all" },
            { id: 9, text: "오늘 할 수 있는 일을 내일로 미루지 마라.", category: "실행력", timeOfDay: "all", season: "all" },
            { id: 10, text: "변화를 두려워하지 마라. 변화는 성장의 시작이다.", category: "변화", timeOfDay: "all", season: "all" },
            
            // 위로와 격려
            { id: 11, text: "모든 일이 잘 될 거야. 걱정하지 마세요.", category: "위로", timeOfDay: "all", season: "all" },
            { id: 12, text: "실패는 성공으로 가는 징검다리입니다.", category: "격려", timeOfDay: "all", season: "all" },
            { id: 13, text: "힘든 시간도 지나갑니다. 조금만 더 버텨요.", category: "위로", timeOfDay: "all", season: "all" },
            { id: 14, text: "당신은 생각보다 훨씬 강한 사람입니다.", category: "격려", timeOfDay: "all", season: "all" },
            { id: 15, text: "오늘도 최선을 다한 당신에게 박수를 보냅니다.", category: "격려", timeOfDay: "evening", season: "all" },
            
            // 긍정과 에너지
            { id: 16, text: "웃음은 마음의 특효약입니다. 오늘 많이 웃으세요! 😊", category: "긍정", timeOfDay: "all", season: "all" },
            { id: 17, text: "좋은 일이 생길 것 같은 기분이 듭니다.", category: "긍정", timeOfDay: "morning", season: "all" },
            { id: 18, text: "에너지 넘치는 하루를 만들어 보세요!", category: "에너지", timeOfDay: "morning", season: "all" },
            { id: 19, text: "긍정적인 마음가짐이 기적을 만듭니다.", category: "긍정", timeOfDay: "all", season: "all" },
            { id: 20, text: "오늘은 특별한 날이 될 것입니다.", category: "기대", timeOfDay: "morning", season: "all" },
            
            // 지혜와 성찰
            { id: 21, text: "진정한 지혜는 자신의 무지를 아는 것이다.", category: "지혜", timeOfDay: "all", season: "all" },
            { id: 22, text: "과거에 연연하지 말고 현재에 집중하세요.", category: "현재", timeOfDay: "all", season: "all" },
            { id: 23, text: "배움에는 끝이 없습니다. 오늘도 새로운 것을 배워보세요.", category: "학습", timeOfDay: "all", season: "all" },
            { id: 24, text: "감사한 마음은 더 많은 행복을 불러옵니다.", category: "감사", timeOfDay: "all", season: "all" },
            { id: 25, text: "인생은 마라톤입니다. 자신의 페이스를 유지하세요.", category: "인생", timeOfDay: "all", season: "all" },
            
            // 관계와 사랑
            { id: 26, text: "사랑하는 사람들에게 따뜻한 말 한마디 건네보세요.", category: "사랑", timeOfDay: "all", season: "all" },
            { id: 27, text: "혼자가 아닙니다. 당신을 아끼는 사람들이 있어요.", category: "위로", timeOfDay: "all", season: "all" },
            { id: 28, text: "진심 어린 한마디가 누군가의 하루를 바꿀 수 있습니다.", category: "관계", timeOfDay: "all", season: "all" },
            { id: 29, text: "용서는 자신을 위한 선물입니다.", category: "용서", timeOfDay: "all", season: "all" },
            { id: 30, text: "소중한 사람들과 함께하는 시간을 더 많이 만드세요.", category: "관계", timeOfDay: "all", season: "all" }
        ];

        // 메시지 데이터 로드
        async function loadMessages() {
            try {
                // 1. 로컬 messages.json 로드 시도
                let localMessages = [];
                try {
                    const response = await fetch('./messages.json');
                    const data = await response.json();
                    localMessages = data.messages || [];
                    console.log(`로컬에서 ${localMessages.length}개의 메시지를 로드했습니다.`);
                } catch (error) {
                    console.log('로컬 메시지 로드 실패, 기본 메시지 사용');
                    localMessages = fallbackMessages;
                }

                // 2. 캐시된 메시지 로드
                const cachedMessages = messageUpdater.loadCachedMessages();
                if (cachedMessages.length > 0) {
                    console.log(`캐시에서 ${cachedMessages.length}개의 메시지를 추가로 로드했습니다.`);
                }

                // 3. 외부 명언 API에서 추가 메시지 로드 시도
                const externalMessages = await loadExternalQuotes();
                
                // 4. 모든 메시지 합치기
                allMessages = [...localMessages, ...cachedMessages, ...externalMessages];
                messages = [...allMessages];
                
                console.log(`총 ${messages.length}개의 메시지를 사용할 수 있습니다.`);

                // 5. 백그라운드에서 업데이트 확인 (비동기)
                setTimeout(async () => {
                    try {
                        await messageUpdater.checkForUpdates();
                    } catch (error) {
                        console.log('백그라운드 업데이트 실패:', error);
                    }
                }, 2000); // 2초 후 실행

                return true;
            } catch (error) {
                console.error('메시지 로드 실패:', error);
                allMessages = fallbackMessages;
                messages = [...fallbackMessages];
                return false;
            }
        }

        // 외부 명언 API에서 메시지 로드
        async function loadExternalQuotes() {
            const externalMessages = [];
            
            try {
                // 한국어 명언 API 시도 (가상의 예시 - 실제로는 존재하는 API 사용)
                const koreanQuotes = await fetchKoreanQuotes();
                externalMessages.push(...koreanQuotes);
            } catch (error) {
                console.log('한국어 명언 API 로드 실패:', error);
            }

            try {
                // 영어 명언을 한국어로 번역한 데이터 로드
                const translatedQuotes = await fetchTranslatedQuotes();
                externalMessages.push(...translatedQuotes);
            } catch (error) {
                console.log('번역된 명언 로드 실패:', error);
            }

            // 랜덤한 추가 메시지 생성
            const additionalMessages = generateAdditionalMessages();
            externalMessages.push(...additionalMessages);

            return externalMessages;
        }

        // 한국어 명언 API 호출 (예시)
        async function fetchKoreanQuotes() {
            // 실제 API가 있다면 여기서 호출
            // 현재는 더미 데이터 반환
            return [
                { id: 1001, text: "천 리 길도 한 걸음부터.", category: "시작", timeOfDay: "all", season: "all" },
                { id: 1002, text: "구슬이 서 말이어도 꿰어야 보배.", category: "완성", timeOfDay: "all", season: "all" },
                { id: 1003, text: "낮말은 새가 듣고 밤말은 쥐가 듣는다.", category: "지혜", timeOfDay: "all", season: "all" },
                { id: 1004, text: "급할수록 돌아가라.", category: "인내", timeOfDay: "all", season: "all" },
                { id: 1005, text: "티끌 모아 태산.", category: "노력", timeOfDay: "all", season: "all" }
            ];
        }

        // 번역된 명언 로드
        async function fetchTranslatedQuotes() {
            // 유명한 영어 명언들을 한국어로 번역한 버전
            return [
                { id: 2001, text: "어제는 지나갔고, 내일은 미지수다. 하지만 오늘은 선물이다.", category: "현재", timeOfDay: "all", season: "all" },
                { id: 2002, text: "위대한 업적을 이루는 유일한 방법은 자신이 하는 일을 사랑하는 것이다.", category: "열정", timeOfDay: "all", season: "all" },
                { id: 2003, text: "성공은 최종 목적지가 아니고, 실패는 치명적이지 않다. 중요한 것은 계속할 용기다.", category: "용기", timeOfDay: "all", season: "all" },
                { id: 2004, text: "자신을 믿어라. 당신은 생각보다 더 용감하고, 보이는 것보다 더 강하다.", category: "자신감", timeOfDay: "all", season: "all" },
                { id: 2005, text: "행복은 준비된 마음이 기회를 만났을 때 일어난다.", category: "행복", timeOfDay: "all", season: "all" }
            ];
        }

        // 추가 메시지 생성 (계절별, 시간별 특화)
        function generateAdditionalMessages() {
            const currentMonth = new Date().getMonth() + 1;
            const currentHour = new Date().getHours();
            
            let seasonalMessages = [];
            
            // 계절별 메시지
            if (currentMonth >= 3 && currentMonth <= 5) { // 봄
                seasonalMessages = [
                    { id: 3001, text: "새싹이 돋듯 새로운 시작을 응원합니다.", category: "계절", timeOfDay: "all", season: "spring" },
                    { id: 3002, text: "봄바람처럼 상쾌한 하루 되세요.", category: "계절", timeOfDay: "morning", season: "spring" }
                ];
            } else if (currentMonth >= 6 && currentMonth <= 8) { // 여름
                seasonalMessages = [
                    { id: 3003, text: "뜨거운 태양처럼 열정적인 하루 보내세요.", category: "계절", timeOfDay: "all", season: "summer" },
                    { id: 3004, text: "여름의 에너지로 활기찬 하루를 만들어보세요.", category: "계절", timeOfDay: "morning", season: "summer" }
                ];
            } else if (currentMonth >= 9 && currentMonth <= 11) { // 가을
                seasonalMessages = [
                    { id: 3005, text: "가을 낙엽처럼 자연스럽게 변화를 받아들이세요.", category: "계절", timeOfDay: "all", season: "autumn" },
                    { id: 3006, text: "가을 하늘처럼 맑은 마음으로 하루를 시작하세요.", category: "계절", timeOfDay: "morning", season: "autumn" }
                ];
            } else { // 겨울
                seasonalMessages = [
                    { id: 3007, text: "겨울의 고요함 속에서 내면의 평화를 찾으세요.", category: "계절", timeOfDay: "all", season: "winter" },
                    { id: 3008, text: "따뜻한 마음으로 추운 겨울을 이겨내세요.", category: "계절", timeOfDay: "all", season: "winter" }
                ];
            }

            // 시간대별 추가 메시지
            const timeBasedMessages = [];
            if (currentHour >= 5 && currentHour < 12) {
                timeBasedMessages.push(
                    { id: 4001, text: "좋은 아침! 오늘도 멋진 하루를 만들어가세요.", category: "아침인사", timeOfDay: "morning", season: "all" },
                    { id: 4002, text: "새벽 공기처럼 맑은 마음으로 시작하세요.", category: "아침인사", timeOfDay: "morning", season: "all" }
                );
            } else if (currentHour >= 12 && currentHour < 17) {
                timeBasedMessages.push(
                    { id: 4003, text: "오후의 햇살처럼 따뜻한 시간 보내세요.", category: "오후", timeOfDay: "afternoon", season: "all" },
                    { id: 4004, text: "하루의 중반, 잠시 쉬어가며 에너지를 충전하세요.", category: "오후", timeOfDay: "afternoon", season: "all" }
                );
            } else if (currentHour >= 17 && currentHour < 21) {
                timeBasedMessages.push(
                    { id: 4005, text: "하루를 마무리하며 오늘의 성취를 축하해주세요.", category: "저녁", timeOfDay: "evening", season: "all" },
                    { id: 4006, text: "석양처럼 아름다운 하루의 마무리를 만들어보세요.", category: "저녁", timeOfDay: "evening", season: "all" }
                );
            } else {
                timeBasedMessages.push(
                    { id: 4007, text: "고민이 많은 밤, 내일은 더 좋은 날이 될 거예요.", category: "밤", timeOfDay: "night", season: "all" },
                    { id: 4008, text: "별빛처럼 어둠 속에서도 빛나는 희망을 찾으세요.", category: "밤", timeOfDay: "night", season: "all" }
                );
            }

            return [...seasonalMessages, ...timeBasedMessages];
        }

        // 메시지 업데이트 시스템
        class MessageUpdateSystem {
            constructor() {
                this.lastUpdateCheck = localStorage.getItem('lastUpdateCheck');
                this.updateInterval = 24 * 60 * 60 * 1000; // 24시간
                this.maxRetries = 3;
            }

            // 메시지 업데이트 확인 및 실행
            async checkForUpdates() {
                const now = Date.now();
                const lastCheck = this.lastUpdateCheck ? parseInt(this.lastUpdateCheck) : 0;
                
                // 24시간마다 한 번 업데이트 확인
                if (now - lastCheck < this.updateInterval) {
                    console.log('최근에 업데이트를 확인했습니다.');
                    return false;
                }

                console.log('새로운 메시지 업데이트를 확인합니다...');
                
                try {
                    // 외부 소스에서 새로운 메시지 가져오기
                    const newMessages = await this.fetchLatestMessages();
                    
                    if (newMessages.length > 0) {
                        await this.addNewMessages(newMessages);
                        console.log(`${newMessages.length}개의 새로운 메시지가 추가되었습니다.`);
                    }

                    // 업데이트 시간 기록
                    localStorage.setItem('lastUpdateCheck', now.toString());
                    return true;
                } catch (error) {
                    console.error('메시지 업데이트 실패:', error);
                    return false;
                }
            }

            // 최신 메시지 가져오기
            async fetchLatestMessages() {
                const newMessages = [];
                
                // 1. 실제로는 여기서 외부 API 호출
                // 예: 명언 API, RSS 피드, 크롤링 등
                
                // 2. 현재는 샘플 데이터 반환
                const sampleNewMessages = this.generateDailyMessages();
                newMessages.push(...sampleNewMessages);

                // 3. 사용자 제출 메시지 가져오기 (API 연동)
                if (authToken) {
                    try {
                        const userSubmittedMessages = await this.fetchUserSubmittedMessages();
                        newMessages.push(...userSubmittedMessages);
                    } catch (error) {
                        console.log('사용자 제출 메시지 로드 실패:', error);
                    }
                }

                return newMessages;
            }

            // 일일 메시지 생성
            generateDailyMessages() {
                const today = new Date();
                const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                
                // 날짜 기반으로 고유한 메시지 생성
                const dailyMessages = [
                    {
                        id: 5000 + dayOfYear,
                        text: this.getDailyInspiration(dayOfYear),
                        category: "오늘의 메시지",
                        timeOfDay: "all",
                        season: "all",
                        isDaily: true,
                        date: today.toISOString().split('T')[0]
                    }
                ];

                return dailyMessages;
            }

            // 날짜별 영감 메시지
            getDailyInspiration(dayOfYear) {
                const inspirations = [
                    "오늘은 새로운 가능성의 날입니다.",
                    "당신의 잠재력을 믿고 도전해보세요.",
                    "작은 진전도 큰 변화의 시작입니다.",
                    "오늘 하루도 감사할 일들이 가득할 거예요.",
                    "당신의 미소가 누군가에게 희망이 됩니다.",
                    "힘든 시간도 성장의 기회가 될 수 있어요.",
                    "오늘도 당신답게 살아가세요.",
                    "새로운 하루, 새로운 기회가 기다립니다.",
                    "당신의 노력은 반드시 보상받을 거예요.",
                    "오늘 하루 자신에게 친절하게 대하세요."
                ];
                
                return inspirations[dayOfYear % inspirations.length];
            }

            // 사용자 제출 메시지 가져오기
            async fetchUserSubmittedMessages() {
                try {
                    const response = await apiCall('/messages/approved');
                    return response.messages || [];
                } catch (error) {
                    return [];
                }
            }

            // 새 메시지 추가
            async addNewMessages(newMessages) {
                // 중복 제거
                const existingIds = new Set(allMessages.map(msg => msg.id));
                const uniqueNewMessages = newMessages.filter(msg => !existingIds.has(msg.id));
                
                if (uniqueNewMessages.length > 0) {
                    allMessages.push(...uniqueNewMessages);
                    messages = [...allMessages];
                    
                    // 로컬 스토리지에 캐시
                    try {
                        localStorage.setItem('cachedMessages', JSON.stringify(uniqueNewMessages));
                        localStorage.setItem('cacheTimestamp', Date.now().toString());
                    } catch (error) {
                        console.log('메시지 캐시 저장 실패:', error);
                    }
                }
            }

            // 캐시된 메시지 로드
            loadCachedMessages() {
                try {
                    const cached = localStorage.getItem('cachedMessages');
                    const timestamp = localStorage.getItem('cacheTimestamp');
                    
                    if (cached && timestamp) {
                        const cacheAge = Date.now() - parseInt(timestamp);
                        // 7일 이내의 캐시만 사용
                        if (cacheAge < 7 * 24 * 60 * 60 * 1000) {
                            return JSON.parse(cached);
                        }
                    }
                } catch (error) {
                    console.log('캐시된 메시지 로드 실패:', error);
                }
                return [];
            }
        }

        // 메시지 업데이트 시스템 인스턴스
        const messageUpdater = new MessageUpdateSystem();


        // 시간대별 메시지 필터링
        function getTimeBasedMessages() {
            const hour = new Date().getHours();
            let timeOfDay;
            
            if (hour >= 5 && hour < 12) timeOfDay = 'morning';
            else if (hour >= 12 && hour < 17) timeOfDay = 'afternoon';
            else if (hour >= 17 && hour < 21) timeOfDay = 'evening';
            else timeOfDay = 'night';
            
            const timeMessages = messages.filter(msg => 
                msg.timeOfDay === timeOfDay || msg.timeOfDay === 'all'
            );
            
            return timeMessages.length > 0 ? timeMessages : messages;
        }

        let currentMessageIndex = 0;

        // 안전한 요소 선택
        function safeGetElement(id) {
            return document.getElementById(id);
        }

        // 메시지 표시
        function showMessage(index = null, useTimeFilter = true) {
            // 메시지가 없으면 리턴
            if (!messages || messages.length === 0) {
                console.error('표시할 메시지가 없습니다.');
                return;
            }
            
            // 시간대별 필터링 적용
            const availableMessages = useTimeFilter ? getTimeBasedMessages() : messages;
            
            // 인덱스 결정
            if (index === null) {
                index = Math.floor(Math.random() * availableMessages.length);
            } else if (index >= availableMessages.length) {
                index = 0;
            }
            
            const message = availableMessages[index];
            currentMessageIndex = messages.findIndex(msg => msg.id === message.id);
            
            // UI 업데이트
            const loading = safeGetElement('loading');
            const quoteContent = safeGetElement('quoteContent');
            const quoteText = safeGetElement('quoteText');
            const quoteCategory = safeGetElement('quoteCategory');
            
            if (loading) loading.style.display = 'none';
            if (quoteContent) quoteContent.style.display = 'block';
            
            if (quoteText) {
                quoteText.textContent = message.text;
                // 텍스트 애니메이션
                quoteText.style.opacity = '0';
                setTimeout(() => {
                    quoteText.style.opacity = '1';
                }, 100);
            }
            
            if (quoteCategory) {
                quoteCategory.textContent = `#${message.category}`;
            }
            
            // 즐겨찾기 상태 확인 및 표시
            const favoriteIcon = document.querySelector('.favorite-icon');
            if (favoriteIcon) {
                const messageId = `msg_${message.id || currentMessageIndex}`;
                favoriteIcon.textContent = isFavorite(messageId) ? '❤️' : '🤍';
            }
            
            // 리액션 UI 업데이트
            const messageId = message.id || currentMessageIndex;
            updateReactionUI(messageId);
            
            // 메시지 히스토리에 추가
            addToHistory(message);
            
            console.log('메시지 표시됨:', message.text);
        }

        // 메시지 히스토리 관리
        let messageHistory = [];
        
        function addToHistory(message) {
            // 중복 제거
            messageHistory = messageHistory.filter(msg => msg.id !== message.id);
            // 최신 메시지를 앞에 추가
            messageHistory.unshift({
                ...message,
                viewedAt: new Date().toISOString()
            });
            // 최대 50개까지만 저장
            if (messageHistory.length > 50) {
                messageHistory = messageHistory.slice(0, 50);
            }
            // 로컬 스토리지에 저장
            localStorage.setItem('messageHistory', JSON.stringify(messageHistory));
        }

        // 히스토리 로드
        function loadHistory() {
            try {
                const saved = localStorage.getItem('messageHistory');
                if (saved) {
                    messageHistory = JSON.parse(saved);
                }
            } catch (error) {
                console.error('히스토리 로드 실패:', error);
                messageHistory = [];
            }
        }

        // 사이드바 관리
        function toggleSidebar() {
            const sidebar = safeGetElement('sidebar');
            const overlay = safeGetElement('sidebarOverlay');
            if (sidebar) sidebar.classList.toggle('open');
            if (overlay) overlay.classList.toggle('show');
        }

        function closeSidebar() {
            const sidebar = safeGetElement('sidebar');
            const overlay = safeGetElement('sidebarOverlay');
            if (sidebar) sidebar.classList.remove('open');
            if (overlay) overlay.classList.remove('show');
        }

        // 인기 메시지 기능
        function showPopularMessages() {
            // 리액션 수가 높은 메시지들을 정렬
            const popularMessages = [];
            
            // 메시지별 총 리액션 수 계산
            for (const messageId in messageReactions) {
                const reactions = messageReactions[messageId];
                const totalReactions = (reactions.like || 0) + (reactions.heart || 0) + (reactions.fire || 0);
                
                if (totalReactions > 0) {
                    // 원본 메시지 찾기
                    const message = messages.find(msg => msg.id == messageId) || 
                                  fallbackMessages.find(msg => msg.id == messageId) ||
                                  { id: messageId, text: '알 수 없는 메시지', category: '기타' };
                    
                    popularMessages.push({
                        ...message,
                        totalReactions,
                        reactions: { ...reactions }
                    });
                }
            }
            
            // 리액션 수 기준 내림차순 정렬
            popularMessages.sort((a, b) => b.totalReactions - a.totalReactions);
            
            // 인기 메시지가 없는 경우 기본 인기 메시지들 표시
            if (popularMessages.length === 0) {
                const defaultPopular = messages.slice(0, 5).map((msg, index) => ({
                    ...msg,
                    totalReactions: 10 - index,
                    reactions: { like: 3, heart: 4, fire: 3 - index }
                }));
                popularMessages.push(...defaultPopular);
            }
            
            // 모달 내용 생성
            const modalContent = `
                <div class="modal" id="popularModal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>🔥 인기 메시지</h2>
                            <button class="modal-close" onclick="document.getElementById('popularModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="popular-messages-list">
                                ${popularMessages.slice(0, 10).map((msg, index) => `
                                    <div class="popular-message-item" onclick="showMessageById('${msg.id}')">
                                        <div class="popular-rank">${index + 1}</div>
                                        <div class="popular-content">
                                            <div class="popular-text">${msg.text}</div>
                                            <div class="popular-category">#${msg.category}</div>
                                        </div>
                                        <div class="popular-reactions">
                                            <span>👍 ${msg.reactions.like || 0}</span>
                                            <span>❤️ ${msg.reactions.heart || 0}</span>
                                            <span>🔥 ${msg.reactions.fire || 0}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        // 메시지 ID로 메시지 표시
        function showMessageById(messageId) {
            const messageIndex = messages.findIndex(msg => msg.id == messageId);
            if (messageIndex >= 0) {
                currentMessageIndex = messageIndex;
                showMessage(messageIndex, false);
                document.getElementById('popularModal')?.remove();
            }
        }

        // 친구 초대 기능
        function showInviteModal() {
            const modalContent = `
                <div class="modal" id="inviteModal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>👥 친구 초대</h2>
                            <button class="modal-close" onclick="document.getElementById('inviteModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="invite-options">
                                <div class="invite-section">
                                    <h3>📱 앱 공유</h3>
                                    <p>친구들과 함께 매일 좋은 메시지를 나눠보세요!</p>
                                    <button class="btn btn-primary" onclick="shareApp()">앱 공유하기</button>
                                </div>
                                
                                <div class="invite-section">
                                    <h3>💌 메시지 공유</h3>
                                    <p>현재 메시지를 친구에게 보내보세요.</p>
                                    <button class="btn btn-secondary" onclick="shareMessage()">현재 메시지 공유</button>
                                </div>
                                
                                <div class="invite-section">
                                    <h3>🔗 초대 링크</h3>
                                    <p>링크를 복사해서 친구들에게 보내세요.</p>
                                    <div class="invite-link">
                                        <input type="text" value="${window.location.href}" readonly>
                                        <button class="btn btn-outline" onclick="copyInviteLink()">복사</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        // 앱 공유하기
        function shareApp() {
            const shareData = {
                title: '모닝 앱 - 매일 좋은 시작',
                text: '매일 아침 좋은 메시지로 하루를 시작해보세요! 🌅',
                url: window.location.href
            };
            
            if (navigator.share) {
                navigator.share(shareData);
            } else {
                // 클립보드 복사
                navigator.clipboard.writeText(`${shareData.title}\n${shareData.text}\n${shareData.url}`);
                alert('앱 정보가 클립보드에 복사되었습니다!');
            }
        }

        // 초대 링크 복사
        function copyInviteLink() {
            const linkInput = document.querySelector('.invite-link input');
            linkInput.select();
            navigator.clipboard.writeText(linkInput.value);
            alert('초대 링크가 복사되었습니다!');
        }

        // 습관 트래커 기능
        function showHabitTracker() {
            const modalContent = `
                <div class="modal" id="habitModal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>📊 습관 트래커</h2>
                            <button class="modal-close" onclick="document.getElementById('habitModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="habit-tracker">
                                <div class="habit-stats">
                                    <div class="stat-item">
                                        <div class="stat-number">${getTodayVisitCount()}</div>
                                        <div class="stat-label">오늘 방문</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">${getStreakCount()}</div>
                                        <div class="stat-label">연속 일수</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">${getTotalMessages()}</div>
                                        <div class="stat-label">본 메시지</div>
                                    </div>
                                </div>
                                
                                <div class="habit-calendar">
                                    <h3>📅 이번 달 활동</h3>
                                    <div id="habitCalendar">${generateHabitCalendar()}</div>
                                </div>
                                
                                <div class="habit-goals">
                                    <h3>🎯 이번 주 목표</h3>
                                    <div class="goal-progress">
                                        <div class="goal-item">
                                            <span>매일 메시지 확인</span>
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${Math.min(100, (getTodayVisitCount() / 1) * 100)}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        // 습관 트래커 유틸리티 함수들
        function getTodayVisitCount() {
            const today = new Date().toDateString();
            const visits = JSON.parse(localStorage.getItem('dailyVisits') || '{}');
            return visits[today] || 0;
        }

        function getStreakCount() {
            const visits = JSON.parse(localStorage.getItem('dailyVisits') || '{}');
            let streak = 0;
            let currentDate = new Date();
            
            while (true) {
                const dateStr = currentDate.toDateString();
                if (visits[dateStr]) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function getTotalMessages() {
            return messageHistory.length;
        }

        function generateHabitCalendar() {
            const visits = JSON.parse(localStorage.getItem('dailyVisits') || '{}');
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            let calendar = '<div class="calendar-grid">';
            
            // 빈 날짜들
            for (let i = 0; i < firstDay.getDay(); i++) {
                calendar += '<div class="calendar-day empty"></div>';
            }
            
            // 실제 날짜들
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(today.getFullYear(), today.getMonth(), day);
                const dateStr = date.toDateString();
                const hasVisit = visits[dateStr] > 0;
                const isToday = day === today.getDate();
                
                calendar += `<div class="calendar-day ${hasVisit ? 'visited' : ''} ${isToday ? 'today' : ''}">${day}</div>`;
            }
            
            calendar += '</div>';
            return calendar;
        }

        // 메시지 제출 기능
        function showSubmitModal() {
            const modalContent = `
                <div class="modal" id="submitModal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>✍️ 메시지 제출</h2>
                            <button class="modal-close" onclick="document.getElementById('submitModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="submit-form">
                                <div class="form-group">
                                    <label for="submitText">💭 메시지 내용</label>
                                    <textarea id="submitText" placeholder="다른 사람들과 나누고 싶은 좋은 메시지를 작성해주세요..." rows="4"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="submitCategory">🏷️ 카테고리</label>
                                    <select id="submitCategory">
                                        <option value="동기부여">동기부여</option>
                                        <option value="감사">감사</option>
                                        <option value="성찰">성찰</option>
                                        <option value="희망">희망</option>
                                        <option value="지혜">지혜</option>
                                        <option value="행복">행복</option>
                                        <option value="기타">기타</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="submitAuthor">👤 작성자 (선택사항)</label>
                                    <input type="text" id="submitAuthor" placeholder="익명">
                                </div>
                                
                                <div class="submit-preview" id="submitPreview" style="display: none;">
                                    <h3>👀 미리보기</h3>
                                    <div class="preview-message">
                                        <div class="preview-text" id="previewText"></div>
                                        <div class="preview-category" id="previewCategory"></div>
                                    </div>
                                </div>
                                
                                <div class="submit-actions">
                                    <button class="btn btn-secondary" onclick="previewSubmission()">미리보기</button>
                                    <button class="btn btn-primary" onclick="submitMessage()">제출하기</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        // 메시지 미리보기
        function previewSubmission() {
            const text = document.getElementById('submitText').value;
            const category = document.getElementById('submitCategory').value;
            
            if (!text.trim()) {
                alert('메시지 내용을 입력해주세요.');
                return;
            }
            
            document.getElementById('previewText').textContent = text;
            document.getElementById('previewCategory').textContent = `#${category}`;
            document.getElementById('submitPreview').style.display = 'block';
        }

        // 메시지 제출
        function submitMessage() {
            const text = document.getElementById('submitText').value;
            const category = document.getElementById('submitCategory').value;
            const author = document.getElementById('submitAuthor').value || '익명';
            
            if (!text.trim()) {
                alert('메시지 내용을 입력해주세요.');
                return;
            }
            
            // 로컬 저장소에 제출된 메시지 저장
            const submittedMessages = JSON.parse(localStorage.getItem('submittedMessages') || '[]');
            const newMessage = {
                id: Date.now(),
                text: text.trim(),
                category,
                author,
                submittedAt: new Date().toISOString(),
                status: 'pending'
            };
            
            submittedMessages.push(newMessage);
            localStorage.setItem('submittedMessages', JSON.stringify(submittedMessages));
            
            alert('메시지가 제출되었습니다! 검토 후 앱에 반영될 예정입니다. 💝');
            document.getElementById('submitModal').remove();
        }

        // 설정 기능
        function showSettingsModal() {
            const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
            
            const modalContent = `
                <div class="modal" id="settingsModal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>⚙️ 앱 설정</h2>
                            <button class="modal-close" onclick="document.getElementById('settingsModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="settings-form">
                                <div class="settings-section">
                                    <h3>🔔 알림 설정</h3>
                                    <div class="setting-item">
                                        <label>
                                            <input type="checkbox" id="enableNotifications" ${settings.enableNotifications ? 'checked' : ''}>
                                            푸시 알림 받기
                                        </label>
                                    </div>
                                    <div class="setting-item">
                                        <label for="notificationTime">알림 시간</label>
                                        <input type="time" id="notificationTime" value="${settings.notificationTime || '09:00'}">
                                    </div>
                                </div>
                                
                                <div class="settings-section">
                                    <h3>🎨 테마 설정</h3>
                                    <div class="setting-item">
                                        <label for="theme">테마 선택</label>
                                        <select id="theme">
                                            <option value="light" ${settings.theme === 'light' ? 'selected' : ''}>밝은 테마</option>
                                            <option value="dark" ${settings.theme === 'dark' ? 'selected' : ''}>어두운 테마</option>
                                            <option value="auto" ${settings.theme === 'auto' ? 'selected' : ''}>자동</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="settings-section">
                                    <h3>📱 앱 정보</h3>
                                    <div class="app-info">
                                        <p><strong>버전:</strong> 1.0.0</p>
                                        <p><strong>개발자:</strong> 모닝팀</p>
                                        <p><strong>문의:</strong> morning@example.com</p>
                                    </div>
                                </div>
                                
                                <div class="settings-actions">
                                    <button class="btn btn-outline" onclick="resetSettings()">설정 초기화</button>
                                    <button class="btn btn-primary" onclick="saveSettings()">저장</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        // 설정 저장
        function saveSettings() {
            const settings = {
                enableNotifications: document.getElementById('enableNotifications').checked,
                notificationTime: document.getElementById('notificationTime').value,
                theme: document.getElementById('theme').value
            };
            
            localStorage.setItem('appSettings', JSON.stringify(settings));
            
            // 테마 적용
            applyTheme(settings.theme);
            
            alert('설정이 저장되었습니다!');
            document.getElementById('settingsModal').remove();
        }

        // 설정 초기화
        function resetSettings() {
            if (confirm('모든 설정을 초기화하시겠습니까?')) {
                localStorage.removeItem('appSettings');
                alert('설정이 초기화되었습니다.');
                document.getElementById('settingsModal').remove();
            }
        }

        // 테마 적용
        function applyTheme(theme) {
            const body = document.body;
            body.classList.remove('light-theme', 'dark-theme');
            
            if (theme === 'dark') {
                body.classList.add('dark-theme');
            } else if (theme === 'light') {
                body.classList.add('light-theme');
            } else {
                // 자동: 시스템 설정 따라가기
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                body.classList.add(prefersDark ? 'dark-theme' : 'light-theme');
            }
        }

        // 일일 방문 추적
        function trackDailyVisit() {
            const today = new Date().toDateString();
            const visits = JSON.parse(localStorage.getItem('dailyVisits') || '{}');
            
            visits[today] = (visits[today] || 0) + 1;
            localStorage.setItem('dailyVisits', JSON.stringify(visits));
        }

        // 즐겨찾기 토글
        // 리액션 기능
        let messageReactions = {};

        // 리액션 데이터 로드
        function loadReactions() {
            try {
                const saved = localStorage.getItem('messageReactions');
                messageReactions = saved ? JSON.parse(saved) : {};
            } catch (error) {
                console.error('리액션 로드 실패:', error);
                messageReactions = {};
            }
        }

        // 리액션 데이터 저장
        function saveReactions() {
            try {
                localStorage.setItem('messageReactions', JSON.stringify(messageReactions));
            } catch (error) {
                console.error('리액션 저장 실패:', error);
            }
        }

        // 리액션 처리
        function handleReaction(reactionType) {
            if (!messages || messages.length === 0 || !messages[currentMessageIndex]) {
                return;
            }
            
            const messageId = messages[currentMessageIndex].id || currentMessageIndex;
            
            // 메시지별 리액션 초기화
            if (!messageReactions[messageId]) {
                messageReactions[messageId] = { like: 0, heart: 0, fire: 0 };
            }
            
            // 사용자별 리액션 상태 체크 (간단한 구현)
            const userReactionKey = `user_${messageId}_${reactionType}`;
            const hasReacted = localStorage.getItem(userReactionKey);
            
            if (hasReacted) {
                // 이미 리액션한 경우 취소
                messageReactions[messageId][reactionType] = Math.max(0, messageReactions[messageId][reactionType] - 1);
                localStorage.removeItem(userReactionKey);
            } else {
                // 새로운 리액션
                messageReactions[messageId][reactionType] += 1;
                localStorage.setItem(userReactionKey, 'true');
            }
            
            // UI 업데이트
            updateReactionUI(messageId);
            saveReactions();
            
            // 간단한 애니메이션 효과
            const btn = document.getElementById(`${reactionType}Btn`);
            if (btn) {
                btn.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    btn.style.transform = 'scale(1)';
                }, 150);
            }
        }

        // 리액션 UI 업데이트
        function updateReactionUI(messageId) {
            if (!messageReactions[messageId]) {
                messageReactions[messageId] = { like: 0, heart: 0, fire: 0 };
            }
            
            const reactions = messageReactions[messageId];
            
            // 각 리액션 카운트 업데이트
            const likeCount = document.getElementById('likeCount');
            const heartCount = document.getElementById('heartCount');
            const fireCount = document.getElementById('fireCount');
            
            if (likeCount) likeCount.textContent = reactions.like || 0;
            if (heartCount) heartCount.textContent = reactions.heart || 0;
            if (fireCount) fireCount.textContent = reactions.fire || 0;
            
            // 사용자가 리액션했는지 표시
            ['like', 'heart', 'fire'].forEach(type => {
                const userReactionKey = `user_${messageId}_${type}`;
                const hasReacted = localStorage.getItem(userReactionKey);
                const btn = document.getElementById(`${type}Btn`);
                
                if (btn) {
                    if (hasReacted) {
                        btn.style.opacity = '1';
                        btn.style.background = '#e3f2fd';
                    } else {
                        btn.style.opacity = '0.7';
                        btn.style.background = '';
                    }
                }
            });
        }

        function toggleFavorite() {
            const favoriteBtn = safeGetElement('favoriteBtn');
            const icon = favoriteBtn?.querySelector('.favorite-icon');
            
            if (!icon || !favoriteBtn) return;
            
            const currentMessage = messages[currentMessageIndex];
            if (!currentMessage) return;
            
            const messageId = `msg_${currentMessage.id || currentMessageIndex}`;
            const isCurrentlyFavorited = icon.textContent === '❤️';
            
            if (!isCurrentlyFavorited) {
                // 즐겨찾기 추가
                const success = addFavorite(messageId, {
                    text: currentMessage.text,
                    category: currentMessage.category,
                    timestamp: new Date().toISOString()
                });
                
                if (success) {
                    icon.textContent = '❤️';
                    console.log('즐겨찾기 추가됨');
                } else {
                    console.log('이미 즐겨찾기에 있는 메시지입니다.');
                }
            } else {
                // 즐겨찾기 제거
                const success = removeFavorite(messageId);
                if (success) {
                    icon.textContent = '🤍';
                    console.log('즐겨찾기 제거됨');
                }
            }
        }

        // 공유 기능
        function shareMessage() {
            const quoteText = safeGetElement('quoteText');
            const messageText = quoteText?.textContent || '새로운 하루가 시작됩니다!';
            const shareText = `${messageText}\n\n🌅 모닝 앱에서`;
            
            if (navigator.share) {
                navigator.share({
                    title: '모닝 - 아침 메시지',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('메시지가 클립보드에 복사되었습니다!');
                });
            }
        }

        // 음성 재생
        function speakMessage() {
            const quoteText = safeGetElement('quoteText');
            const messageText = quoteText?.textContent || '새로운 하루가 시작됩니다!';
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(messageText);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            } else {
                alert('음성 재생을 지원하지 않는 브라우저입니다.');
            }
        }

        // 날짜 표시
        function displayDate() {
            const dateDisplay = safeGetElement('dateDisplay');
            if (dateDisplay) {
                const today = new Date();
                dateDisplay.textContent = today.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
            }
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            console.log('이벤트 리스너 설정 중...');
            
            // 햄버거 메뉴
            const hamburgerBtn = safeGetElement('hamburgerBtn');
            const sidebarClose = safeGetElement('sidebarClose');
            const sidebarOverlay = safeGetElement('sidebarOverlay');
            
            if (hamburgerBtn) hamburgerBtn.addEventListener('click', toggleSidebar);
            if (sidebarClose) sidebarClose.addEventListener('click', closeSidebar);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);
            
            // 리액션 버튼들
            const likeBtn = safeGetElement('likeBtn');
            const heartBtn = safeGetElement('heartBtn');
            const fireBtn = safeGetElement('fireBtn');
            
            if (likeBtn) likeBtn.addEventListener('click', () => handleReaction('like'));
            if (heartBtn) heartBtn.addEventListener('click', () => handleReaction('heart'));
            if (fireBtn) fireBtn.addEventListener('click', () => handleReaction('fire'));
            
            // 퀵 액션 버튼들
            const quickNewBtn = safeGetElement('quickNewBtn');
            const quickShareBtn = safeGetElement('quickShareBtn');
            const quickSpeakBtn = safeGetElement('quickSpeakBtn');
            
            if (quickNewBtn) quickNewBtn.addEventListener('click', () => showMessage());
            if (quickShareBtn) quickShareBtn.addEventListener('click', shareMessage);
            if (quickSpeakBtn) quickSpeakBtn.addEventListener('click', speakMessage);
            
            // 새 메시지 버튼들
            const newQuoteBtn = safeGetElement('newQuoteBtn');
            
            if (newQuoteBtn) {
                newQuoteBtn.addEventListener('click', () => {
                    showMessage();
                    closeSidebar();
                });
            }
            
            // 즐겨찾기 버튼
            const favoriteBtn = safeGetElement('favoriteBtn');
            if (favoriteBtn) {
                favoriteBtn.addEventListener('click', toggleFavorite);
            }
            
            
            // 인증 폼 이벤트 리스너
            const loginForm = safeGetElement('loginForm');
            const registerForm = safeGetElement('registerForm');
            
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = safeGetElement('loginUsername').value;
                    const password = safeGetElement('loginPassword').value;
                    
                    try {
                        showAuthMessage('로그인 중...', false);
                        await login(username, password);
                        showAuthMessage('로그인 성공!', false);
                        setTimeout(() => {
                            const modal = safeGetElement('authModal');
                            if (modal) modal.style.display = 'none';
                        }, 1000);
                    } catch (error) {
                        showAuthMessage('로그인 실패: 사용자명 또는 비밀번호를 확인해주세요.', true);
                    }
                });
            }
            
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = safeGetElement('registerUsername').value;
                    const email = safeGetElement('registerEmail').value;
                    const displayName = safeGetElement('registerDisplayName').value;
                    const password = safeGetElement('registerPassword').value;
                    const passwordConfirm = safeGetElement('registerPasswordConfirm').value;
                    
                    if (password !== passwordConfirm) {
                        showAuthMessage('비밀번호가 일치하지 않습니다.', true);
                        return;
                    }
                    
                    try {
                        showAuthMessage('회원가입 중...', false);
                        await register(username, email, password, displayName);
                        showAuthMessage('회원가입 성공!', false);
                        setTimeout(() => {
                            const modal = safeGetElement('authModal');
                            if (modal) modal.style.display = 'none';
                        }, 1000);
                    } catch (error) {
                        showAuthMessage('회원가입 실패: 사용자명이 이미 존재하거나 입력 정보를 확인해주세요.', true);
                    }
                });
            }

            // 모달 닫기 버튼들
            const modalCloseButtons = document.querySelectorAll('.modal-close');
            modalCloseButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modalId = this.getAttribute('data-modal');
                    const modal = modalId ? safeGetElement(modalId) : this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
            });

            // 모달 배경 클릭시 닫기
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });

            // 메뉴 아이템들
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const action = this.id.replace('Btn', '');
                    console.log('메뉴 클릭:', action);
                    
                    switch(action) {
                        case 'newQuote':
                            showMessage();
                            break;
                        case 'favorites':
                            showFavoritesModal();
                            break;
                        case 'history':
                            showHistoryModal();
                            break;
                        case 'popular':
                            showPopularMessages();
                            break;
                        case 'share':
                            shareMessage();
                            break;
                        case 'invite':
                            showInviteModal();
                            break;
                        case 'habit':
                            showHabitTracker();
                            break;
                        case 'submit':
                            showSubmitModal();
                            break;
                        case 'settings':
                            showSettingsModal();
                            break;
                        default:
                            console.log('알 수 없는 액션:', action);
                    }
                    closeSidebar();
                });
            });
            
            console.log('이벤트 리스너 설정 완료');
        }

        // 초기화
        async function init() {
            console.log('앱 초기화 시작...');
            
            try {
                // 데이터 로드
                await loadMessages(); // 메시지 데이터 로드
                loadUserSession(); // 사용자 세션 로드
                loadHistory(); // 히스토리 로드
                loadLocalFavorites(); // 로컬 즐겨찾기 로드
                loadReactions(); // 리액션 데이터 로드
                
                // UI 초기화
                setupEventListeners();
                trackDailyVisit(); // 일일 방문 추적
                showMessage(); // 랜덤 메시지 표시
                displayDate();
                
                console.log('앱 초기화 완료!');
            } catch (error) {
                console.error('초기화 오류:', error);
                // 최소한 메시지라도 표시
                const loading = safeGetElement('loading');
                const quoteContent = safeGetElement('quoteContent');
                const quoteText = safeGetElement('quoteText');
                
                if (loading) loading.style.display = 'none';
                if (quoteContent) quoteContent.style.display = 'block';
                if (quoteText) quoteText.textContent = '새로운 하루가 시작됩니다. 오늘도 좋은 하루 되세요! ✨';
            }
        }

        // 즉시 실행 (강제)
        console.log('즉시 실행 시작...');
        
        // 0.5초 후 강제 실행
        setTimeout(() => {
            console.log('강제 실행 중...');
            try {
                // 바로 로딩 숨기고 메시지 표시
                const loading = document.getElementById('loading');
                const quoteContent = document.getElementById('quoteContent');
                const quoteText = document.getElementById('quoteText');
                const quoteCategory = document.getElementById('quoteCategory');
                
                if (loading) {
                    loading.style.display = 'none';
                    console.log('로딩 숨김');
                }
                if (quoteContent) {
                    quoteContent.style.display = 'block';
                    console.log('콘텐츠 표시');
                }
                if (quoteText) {
                    quoteText.textContent = '새로운 하루가 시작됩니다. 오늘도 좋은 하루 되세요! 🌅';
                    console.log('메시지 텍스트 설정');
                }
                if (quoteCategory) {
                    quoteCategory.textContent = '#새로운 시작';
                    console.log('카테고리 설정');
                }
                
                // 이벤트 리스너도 설정
                setupEventListeners();
                
                console.log('강제 실행 완료!');
            } catch (error) {
                console.error('강제 실행 오류:', error);
            }
        }, 500);

        // DOM 로드 완료 후에도 실행
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        console.log('스크립트 로딩 완료');
    </script>
</body>
</html>