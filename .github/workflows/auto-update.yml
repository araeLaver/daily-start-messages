name: ğŸ”„ Auto Update Dependencies

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST)
    - cron: '0 0 * * 1'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-messages:
    name: ğŸ“ Update Message Database
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Validate Messages JSON
        run: |
          # JSON ìœ íš¨ì„± ê²€ì‚¬
          python -c "
          import json
          with open('messages.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          print(f'âœ… Found {len(data[\"messages\"])} messages')
          print(f'âœ… Found {len(data[\"categories\"])} categories')
          "

      - name: ğŸ“Š Generate Statistics
        run: |
          python -c "
          import json
          from collections import Counter
          
          with open('messages.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          messages = data['messages']
          
          # ì¹´í…Œê³ ë¦¬ë³„ í†µê³„
          categories = Counter(msg['category'] for msg in messages)
          print('ğŸ“Š Category Statistics:')
          for cat, count in categories.most_common():
              print(f'  {cat}: {count}')
          
          # ì‹œê°„ëŒ€ë³„ í†µê³„
          times = Counter(msg.get('timeOfDay', 'any') for msg in messages)
          print('\nâ° Time Distribution:')
          for time, count in times.items():
              print(f'  {time}: {count}')
          
          # ì „ì²´ í†µê³„
          print(f'\nğŸ“ˆ Total Messages: {len(messages)}')
          print(f'ğŸ“ˆ Total Categories: {len(set(msg[\"category\"] for msg in messages))}')
          print(f'ğŸ“ˆ Messages with Time: {len([m for m in messages if m.get(\"timeOfDay\")]))}')
          "

      - name: ğŸ”„ Auto-commit if changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [[ `git status --porcelain` ]]; then
            git add .
            git commit -m "ğŸ”„ Auto-update: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… Changes committed and pushed"
          else
            echo "âœ… No changes to commit"
          fi

  check-pwa-health:
    name: ğŸ¥ PWA Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” PWA Lighthouse Audit
        uses: treosh/lighthouse-ci-action@v9
        with:
          configPath: './.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

      - name: ğŸ”’ Check for vulnerable dependencies
        run: |
          # HTML/CSS/JS íŒŒì¼ì—ì„œ ì™¸ë¶€ CDN ë§í¬ í™•ì¸
          echo "ğŸ” Checking external dependencies..."
          
          # Google Fonts ì²´í¬
          if grep -q "googleapis.com" *.html *.css; then
            echo "âœ… Google Fonts detected - generally safe"
          fi
          
          # ê¸°íƒ€ ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ ì²´í¬
          external_scripts=$(grep -h "src.*http" *.html || true)
          if [ -n "$external_scripts" ]; then
            echo "âš ï¸  External scripts found:"
            echo "$external_scripts"
          else
            echo "âœ… No external scripts found"
          fi

  performance-check:
    name: ğŸš€ Performance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“ Check File Sizes
        run: |
          echo "ğŸ“ File Size Analysis:"
          
          # HTML íŒŒì¼ í¬ê¸°
          html_size=$(wc -c < index.html)
          echo "ğŸ“„ HTML: ${html_size} bytes"
          
          # CSS íŒŒì¼ í¬ê¸°
          css_size=$(wc -c < styles.css)
          echo "ğŸ¨ CSS: ${css_size} bytes"
          
          # JS íŒŒì¼ í¬ê¸°
          js_size=$(wc -c < script.js)
          echo "âš™ï¸ JavaScript: ${js_size} bytes"
          
          # JSON íŒŒì¼ í¬ê¸°
          json_size=$(wc -c < messages.json)
          echo "ğŸ“ Messages: ${json_size} bytes"
          
          # ì „ì²´ í¬ê¸°
          total_size=$((html_size + css_size + js_size + json_size))
          echo "ğŸ“¦ Total Core Size: ${total_size} bytes"
          
          # ê²½ê³  ì²´í¬
          if [ $total_size -gt 500000 ]; then
            echo "âš ï¸ Warning: Total size exceeds 500KB"
          else
            echo "âœ… Total size is optimal"
          fi

      - name: ğŸ” Code Quality Check
        run: |
          echo "ğŸ” Code Quality Analysis:"
          
          # JavaScript í•¨ìˆ˜ ìˆ˜ ì²´í¬
          js_functions=$(grep -c "function\|=>" script.js || echo "0")
          echo "âš™ï¸ JavaScript functions: ${js_functions}"
          
          # CSS ê·œì¹™ ìˆ˜ ì²´í¬  
          css_rules=$(grep -c "{" styles.css || echo "0")
          echo "ğŸ¨ CSS rules: ${css_rules}"
          
          # HTML ìš”ì†Œ ìˆ˜ ì²´í¬
          html_elements=$(grep -o "<[^/][^>]*>" index.html | wc -l)
          echo "ğŸ“„ HTML elements: ${html_elements}"
          
          echo "âœ… Code quality check completed"