name: ğŸš€ Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  lint-and-test:
    name: ğŸ“ Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Validate HTML
        uses: Cyb3r-Jak3/html5validator-action@v7.2.0
        with:
          root: ./
          format: text

      - name: ğŸ¨ Check CSS Syntax
        run: |
          # CSS ê¸°ë³¸ êµ¬ë¬¸ ê²€ì‚¬ (ê°„ë‹¨í•œ íŒŒì‹± ì²´í¬)
          echo "Checking CSS syntax..."
          if grep -q "}" styles.css && grep -q "{" styles.css; then
            echo "âœ… CSS syntax appears valid"
          else
            echo "âŒ CSS syntax error detected"
            exit 1
          fi

      - name: ğŸ“‹ Validate JSON
        run: |
          python -m json.tool messages.json > /dev/null
          python -m json.tool manifest.json > /dev/null
          echo "âœ… JSON files are valid"

      - name: ğŸ”§ Check PWA Manifest
        run: |
          node -e "
            const manifest = require('./manifest.json');
            const required = ['name', 'short_name', 'start_url', 'display', 'theme_color', 'background_color', 'icons'];
            const missing = required.filter(field => !manifest[field]);
            if (missing.length > 0) {
              console.error('âŒ Missing required manifest fields:', missing);
              process.exit(1);
            }
            console.log('âœ… PWA manifest is valid');
          "

  # ë°°í¬ í™˜ê²½ë³„ ë¶„ê¸°
  deploy-preview:
    name: ğŸ” Deploy Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: lint-and-test
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy to Netlify Preview
        uses: nwtgck/actions-netlify@v2.0
        with:
          publish-dir: './.'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Preview Deploy from PR #${{ github.event.number }}"
          alias: pr-${{ github.event.number }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: lint-and-test
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¯ Generate Build Info
        run: |
          echo "BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          echo "COMMIT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV
          echo "BUILD_NUMBER=${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      - name: ğŸ“ Update Build Info in HTML
        run: |
          sed -i "s/<!-- BUILD_INFO -->/<!-- Build: $BUILD_NUMBER | Commit: $COMMIT_SHA | Time: $BUILD_TIME -->/g" index.html

      - name: ğŸš€ Deploy to Netlify Production
        uses: nwtgck/actions-netlify@v2.0
        with:
          publish-dir: './.'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "ğŸš€ Production Deploy - Build ${{ env.BUILD_NUMBER }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: ğŸ“± Update PWA Cache Version
        run: |
          # ì„œë¹„ìŠ¤ ì›Œì»¤ì˜ ìºì‹œ ë²„ì „ ì—…ë°ì´íŠ¸
          sed -i "s/const CACHE_NAME = 'morning-app-v2'/const CACHE_NAME = 'morning-app-v${{ env.BUILD_NUMBER }}'/g" service-worker.js

  # í’ˆì§ˆ ì²´í¬ (ë°°í¬ í›„)
  post-deploy-check:
    name: ğŸ” Post-Deploy Quality Check
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸŒ Check Website Status
        run: |
          sleep 30  # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
          response=$(curl -s -o /dev/null -w "%{http_code}" https://daily-start-messages.netlify.app)
          if [ $response -eq 200 ]; then
            echo "âœ… Website is accessible"
          else
            echo "âŒ Website returned status code: $response"
            exit 1
          fi

      - name: ğŸ“± Check PWA Manifest
        run: |
          curl -s https://daily-start-messages.netlify.app/manifest.json | python -m json.tool > /dev/null
          echo "âœ… PWA manifest is accessible and valid"

      - name: ğŸ”§ Check Service Worker
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://daily-start-messages.netlify.app/service-worker.js)
          if [ $response -eq 200 ]; then
            echo "âœ… Service worker is accessible"
          else
            echo "âŒ Service worker not found"
            exit 1
          fi

  # ì•Œë¦¼ (ì„±ê³µ/ì‹¤íŒ¨)
  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deploy-check]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ‰ Success Notification
        if: needs.deploy-production.result == 'success' && needs.post-deploy-check.result == 'success'
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸŒ Live URL: https://daily-start-messages.netlify.app"
          echo "ğŸ“± PWA: Ready for installation"
          echo "ğŸ” All quality checks passed"

      - name: âŒ Failure Notification
        if: needs.deploy-production.result == 'failure' || needs.post-deploy-check.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ” Check the logs for details"
          exit 1